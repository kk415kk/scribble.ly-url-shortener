<!DOCTYPE html>
{% extends "layout.html" %}
{% block body %}
<div class="home-form">
  <div id="flash-messages">
  </div>
  <form id="shorten-form" onsubmit="return false;">
    <h2><a href="{{ config['APPLICATION_ROOT'] }}">scribble.ly</a></h2>
    <br>
    <div class="form-group">
      <label>URL:</label>
      <div class="input-group shift-left">
        <div class="input-group-addon">www.</div>
        <input class="url-box" type="text" name="url"><br>
      </div>
    </div>
    <div class="form-group">
      <input type="submit" class="btn btn-primary btn-sm" value="scribble">
    </div>
  </form>

  <br>
  <br>
  <div id="output-url">
  </div>
  <br>
  <br>
  <svg id="live-graph" width="1000" height="500">
  </svg>
</div>

<script>
  var protocol = "http://"
  var host = window.location.host
  var pathname = window.location.pathname.split("/").slice(0,3).join('/');
  var basePath = protocol + host + pathname;

  if (host != "people.ischool.berkeley.edu") {
    basePath = protocol + host;
  }

  $(document).ready(function() {
    {% if get_flashed_messages() %}
      var text = "<div id='flash' class='alert alert-info' style='display: none;'>";
      {% for message in get_flashed_messages() %}
        text = text + "<p>" + "{{ message }}" + "</p>"
      {% endfor %}
      text += "</div>"
      $("#flash-messages").html(text);
      $("#flash").fadeIn();
    {% endif %}

    // Poll to update homepage graph
    var graphData = [1,2,3];
    var width = 600;
    var height = 400;
    var max = d3.max(graphData);

    x = d3.scale.linear().domain([0, graphData.length - 1]).range([0, width]);
    y = d3.scale.linear().domain([0, max]).range([height, 0]);

    vis = d3.select('#live-graph')
        .style('margin', '20px auto')
        .style('width', "" + width + "px")
        .append('svg:svg')
        .attr('width', width)
        .attr('height', height)
        .attr('class', 'viz')
        .append('svg:g');

    vis.selectAll('path.line')
        .data([graphData])
        .enter()
        .append("svg:path")
        .attr("d", d3.svg.line().x(function(d, i) {
          return x(i);
        })
        .y(y));

    var updateGraph = function() {
      $.get("/analytics", function(data) {
        // do something
        graphData = data['new_data'];
      });
    };
    setInterval(updateGraph, 2000);
  })

  $("#shorten-form").submit(function(event) {
    event.preventDefault();
    var values = $(this).serialize();
    var url = values.split("=").slice(1).join("");
    if (url == "") {
      var text = "<div id='flash' class='alert alert-info' style='display: none;'>";
      text += "Please fill in a valid URL to be scribbled.";
      text += "</div>";
      $("#flash-messages").html(text);
      $("#flash").fadeIn();
    } else {
      $.post(basePath + "/shorts", { url: url }, function(data) {
        display_url(data['s_url']);
      });
    }
  })

  function display_url(s_url) {
    close("#flash-messages");
    var text = "<div id='output' class='alert alert-info' style='display: none;'><p>Your shortened URL is: ";
    text += "<a target='_blank' href='"
    text += basePath
    text += "/short/";
    text += s_url.toString();
    text += "'>scribble.ly/";
    text += s_url.toString();
    text += "</a></p>";
    text += "<p>The shortcode slug is: ";
    text += s_url.toString();
    text += "</p>";
    text += "</div>";
    $("#output-url").html(text);
    $("#output").fadeIn();
  }

  function close(element) {
    $(element).html("");
  }
</script>
{% endblock %}
